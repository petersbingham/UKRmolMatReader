import os
import sys
basedir = os.path.dirname(os.path.realpath(__file__))
sys.path.insert(0,basedir+'/../..')

import ukrmolmatreader as matRead

import unittest

class test_water_mats(unittest.TestCase):
    def runTest(self):
        kmats,oChanDesc = matRead.read_Kmats("water_inel_B1_10ch.19")
        self.assertEqual(oChanDesc[0],[4,[0,1025]])
        self.assertEqual(oChanDesc[1],[10,[1025,1800]])

        expectMat = matRead.nw.matrix(\
          [[-0.44319103+0.j,  0.17810525+0.j,  0.00342772+0.j, -0.03147134+0.j],
           [ 0.17810525+0.j, -0.00818044+0.j,  0.09482788+0.j, -0.00245007+0.j],
           [ 0.00342772+0.j,  0.09482788+0.j, -0.03620601+0.j,  0.01289757+0.j],
           [-0.03147134+0.j, -0.00245007+0.j,  0.01289757+0.j, -0.00201263+0.j]])
        gotMat = kmats[sorted(kmats.keys())[oChanDesc[0][1][0]]]
        self.assertTrue(matRead.nw.np.allclose(gotMat,expectMat))

        expectMat = matRead.nw.matrix(\
          [[-0.26747129+0.j,  0.22920894+0.j,  0.00411863+0.j, -0.05363465+0.j],
           [ 0.22920894+0.j,  0.01053106+0.j,  0.09419787+0.j, -0.00749202+0.j],
           [ 0.00411863+0.j,  0.09419787+0.j, -0.03436892+0.j,  0.01474346+0.j],
           [-0.05363465+0.j, -0.00749202+0.j,  0.01474346+0.j,  0.00465384+0.j]])
        gotMat = kmats[sorted(kmats.keys())[oChanDesc[0][1][1]-1]]
        self.assertTrue(matRead.nw.np.allclose(gotMat,expectMat))

        expectMat = matRead.nw.matrix(\
          [[ -7.14345516e-01+0.j,   1.50788886e-01+0.j,   2.80918002e-03+0.j,
             -1.82148394e-02+0.j,   4.74636829e-01+0.j,   4.48834796e-02+0.j,
             -4.05935032e-02+0.j,   9.30021072e-05+0.j,   8.06564379e-02+0.j,
             -5.87791145e-05+0.j],
           [  1.50788886e-01+0.j,  -3.22535374e-03+0.j,   9.39669124e-02+0.j,
             -1.27537592e-03+0.j,   8.33508045e-02+0.j,   7.85207238e-03+0.j,
             -7.18155622e-03+0.j,   1.62670575e-05+0.j,   1.41462540e-02+0.j,
             -1.11660497e-05+0.j],
           [  2.80918002e-03+0.j,   9.39669124e-02+0.j,  -3.43707651e-02+0.j,
              1.48491740e-02+0.j,   1.39628430e-03+0.j,   1.27479207e-04+0.j,
             -1.28290455e-04+0.j,   1.54010397e-07+0.j,   2.33443050e-04+0.j,
             -2.43644734e-07+0.j],
           [ -1.82148394e-02+0.j,  -1.27537592e-03+0.j,   1.48491740e-02+0.j,
              1.85068698e-03+0.j,  -3.76319737e-02+0.j,  -3.55801150e-03+0.j,
              3.21959611e-03+0.j,  -5.44268634e-06+0.j,  -6.39468860e-03+0.j,
              3.66576690e-06+0.j],
           [  4.74636829e-01+0.j,   8.33508045e-02+0.j,   1.39628430e-03+0.j,
             -3.76319737e-02+0.j,  -9.41438282e-01+0.j,  -3.83863218e-01+0.j,
              7.55748638e-02+0.j,  -2.11811112e-04+0.j,  -1.54681276e-01+0.j,
              1.37121107e-04+0.j],
           [  4.48834796e-02+0.j,   7.85207238e-03+0.j,   1.27479207e-04+0.j,
             -3.55801150e-03+0.j,  -3.83863218e-01+0.j,  -5.57741557e-02+0.j,
             -1.31916733e-01+0.j,  -4.17962119e-06+0.j,  -1.21806520e-03+0.j,
              2.71997848e-06+0.j],
           [ -4.05935032e-02+0.j,  -7.18155622e-03+0.j,  -1.28290455e-04+0.j,
              3.21959611e-03+0.j,   7.55748638e-02+0.j,  -1.31916733e-01+0.j,
             -6.71836219e-03+0.j,  -2.82577176e-06+0.j,  -8.99751195e-02+0.j,
              1.82942650e-06+0.j],
           [  9.30021072e-05+0.j,   1.62670575e-05+0.j,   1.54010397e-07+0.j,
             -5.44268634e-06+0.j,  -2.11811112e-04+0.j,  -4.17962119e-06+0.j,
             -2.82577176e-06+0.j,   7.43250689e-03+0.j,   7.27323385e-07+0.j,
             -6.48442319e-02+0.j],
           [  8.06564379e-02+0.j,   1.41462540e-02+0.j,   2.33443050e-04+0.j,
             -6.39468860e-03+0.j,  -1.54681276e-01+0.j,  -1.21806520e-03+0.j,
             -8.99751195e-02+0.j,   7.27323385e-07+0.j,  -9.46858304e-03+0.j,
              1.58364738e-08+0.j],
           [ -5.87791145e-05+0.j,  -1.11660497e-05+0.j,  -2.43644734e-07+0.j,
              3.66576690e-06+0.j,   1.37121107e-04+0.j,   2.71997848e-06+0.j,
              1.82942650e-06+0.j,  -6.48442319e-02+0.j,   1.58364738e-08+0.j,
             -5.18738848e-03+0.j]])

        gotMat = kmats[sorted(kmats.keys())[oChanDesc[0][1][1]]]
        self.assertTrue(matRead.nw.np.allclose(gotMat,expectMat))

        gotMat = kmats[sorted(kmats.keys())[oChanDesc[1][1][0]]]
        self.assertTrue(matRead.nw.np.allclose(gotMat,expectMat))

        expectMat = matRead.nw.matrix(\
          [[ -5.51108811e-01+0.j,   1.94636399e-01+0.j,   3.43177973e-03+0.j,
             -3.74273992e-02+0.j,  -1.04283938e-01+0.j,  -3.11840165e-02+0.j,
              7.27068060e-04+0.j,  -7.19236720e-03+0.j,   5.05822997e-06+0.j,
             -2.29205496e-04+0.j],
           [  1.94636399e-01+0.j,   1.20478688e-02+0.j,   9.30338647e-02+0.j,
             -5.41857058e-03+0.j,  -1.89102841e-02+0.j,  -1.56522544e-02+0.j,
             -1.46636922e-03+0.j,  -6.40533889e-04+0.j,   1.15296431e-04+0.j,
             -2.83335165e-04+0.j],
           [  3.43177973e-03+0.j,   9.30338647e-02+0.j,  -3.31911888e-02+0.j,
              1.60680103e-02+0.j,  -3.25221728e-04+0.j,  -1.60775853e-03+0.j,
             -1.03552056e-03+0.j,   1.65915417e-04+0.j,  -2.73000624e-05+0.j,
             -3.39810745e-05+0.j],
           [ -3.74273992e-02+0.j,  -5.41857058e-03+0.j,   1.60680103e-02+0.j,
              6.58506317e-03+0.j,   9.01334438e-03+0.j,   2.92148923e-03+0.j,
             -5.32909316e-05+0.j,  -1.07525312e-03+0.j,  -1.41202887e-05+0.j,
             -6.17687541e-05+0.j],
           [ -1.04283938e-01+0.j,  -1.89102841e-02+0.j,  -3.25221728e-04+0.j,
              9.01334438e-03+0.j,   6.27299819e-01+0.j,   1.50778624e-01+0.j,
              2.01961953e-02+0.j,  -2.79174826e-02+0.j,   8.29651930e-04+0.j,
             -3.33198254e-03+0.j],
           [ -3.11840165e-02+0.j,  -1.56522544e-02+0.j,  -1.60775853e-03+0.j,
              2.92148923e-03+0.j,   1.50778624e-01+0.j,   6.54548731e-03+0.j,
             -1.23198370e-01+0.j,  -1.04090144e-02+0.j,  -5.65038213e-03+0.j,
              3.06239286e-04+0.j],
           [  7.27068060e-04+0.j,  -1.46636922e-03+0.j,  -1.03552056e-03+0.j,
             -5.32909316e-05+0.j,   2.01961953e-02+0.j,  -1.23198370e-01+0.j,
             -2.03558864e-02+0.j,  -4.12788022e-03+0.j,  -8.76548103e-02+0.j,
              1.86414874e-05+0.j],
           [ -7.19236720e-03+0.j,  -6.40533889e-04+0.j,   1.65915417e-04+0.j,
             -1.07525312e-03+0.j,  -2.79174826e-02+0.j,  -1.04090144e-02+0.j,
             -4.12788022e-03+0.j,   2.31563302e-02+0.j,  -2.11503462e-04+0.j,
             -6.32213657e-02+0.j],
           [  5.05822997e-06+0.j,   1.15296431e-04+0.j,  -2.73000624e-05+0.j,
             -1.41202887e-05+0.j,   8.29651930e-04+0.j,  -5.65038213e-03+0.j,
             -8.76548103e-02+0.j,  -2.11503462e-04+0.j,  -1.59924049e-02+0.j,
             -3.73973540e-04+0.j],
           [ -2.29205496e-04+0.j,  -2.83335165e-04+0.j,  -3.39810745e-05+0.j,
             -6.17687541e-05+0.j,  -3.33198254e-03+0.j,   3.06239286e-04+0.j,
              1.86414874e-05+0.j,  -6.32213657e-02+0.j,  -3.73973540e-04+0.j,
             -5.56060761e-03+0.j]])

        gotMat = kmats[sorted(kmats.keys())[oChanDesc[1][1][1]-1]]
        self.assertTrue(matRead.nw.np.allclose(gotMat,expectMat))

if __name__ == "__main__":
    #Just for debug
    b = test_water_mats()
    b.runTest()
